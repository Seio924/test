name: Deployment Notification to Discord

on:
  push:
    branches:
      - develop
      - master

jobs:
  notify-discord:
    name: Notify Discord on Push
    runs-on: ubuntu-latest

    steps:
      - name: Wait for deployment
        run: sleep 30 # Vercel Î∞∞Ìè¨ ÎåÄÍ∏∞

      - name: Notify Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          BRANCH="${{ github.ref_name }}"
          REPO="${{ github.repository }}"
          COMMIT="${{ github.sha }}"
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          AUTHOR="${{ github.event.head_commit.author.name }}"

          # Discord embed Î©îÏãúÏßÄ ÏÉùÏÑ±
          JSON_PAYLOAD=$(cat <<EOF
          {
            "embeds": [
              {
                "title": "üöÄ Î∞∞Ìè¨ ÏãúÏûëÎê®",
                "color": 3447003,
                "fields": [
                  {
                    "name": "Î∏åÎûúÏπò",
                    "value": "$BRANCH",
                    "inline": true
                  },
                  {
                    "name": "Ï†ÄÏû•ÏÜå",
                    "value": "$REPO",
                    "inline": true
                  },
                  {
                    "name": "ÏûëÏÑ±Ïûê",
                    "value": "$AUTHOR",
                    "inline": true
                  },
                  {
                    "name": "Ïª§Î∞ã Î©îÏãúÏßÄ",
                    "value": "$COMMIT_MESSAGE"
                  },
                  {
                    "name": "Ïª§Î∞ã",
                    "value": "\`${COMMIT:0:7}\`",
                    "inline": true
                  }
                ],
                "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
              }
            ]
          }
          EOF
          )

          curl -H "Content-Type: application/json" \
               -d "$JSON_PAYLOAD" \
               $DISCORD_WEBHOOK_URL
